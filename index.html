<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ëª¸ìœ¼ë¡œ ë§í•´ìš” í€´ì¦ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        #score-board {
            position: absolute;
            top: 20px;
            right: 30px;
            background-color: #ff6b6b;
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
        }
        h1 { margin-bottom: 10px; color: #4a90e2; }
        
        /* ì´ë¦„ ì…ë ¥ì¹¸ ìŠ¤íƒ€ì¼ */
        #name-input {
            padding: 15px;
            font-size: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            width: 60%;
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Jua', sans-serif;
        }

        #question-box {
            font-size: 28px;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #eee;
            border-radius: 15px;
            padding: 20px;
        }
        #webcam-container {
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            border: 5px solid #ddd;
            width: 400px; 
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333;
            position: relative;
        }
        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        #progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 10px;
            height: 30px;
            display: none; 
            position: relative;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #2ecc71; 
            transition: width 0.1s linear;
        }
        #progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 5px;
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }

        #start-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Jua', sans-serif;
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); background-color: #357abd; }
        #start-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #result-message {
            font-size: 40px;
            font-weight: bold;
            height: 50px;
            margin-top: 10px;
        }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }
    </style>
</head>
<body>

    <div id="score-board">ì ìˆ˜: <span id="score-val">0</span>ì </div>

    <div class="container">
        <h1>ğŸ¤– AI O/X í€´ì¦ˆ ê²Œì„</h1>
        <div id="question-box">ì´ë¦„ì„ ì…ë ¥í•˜ê³  ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
        
        <input type="text" id="name-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™)">

        <div id="webcam-container">
            <span style="color:white; font-size: 20px;">ì¹´ë©”ë¼ ë¡œë”© ëŒ€ê¸°ì¤‘...</span>
        </div>

        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="progress-text">ìì„¸ ìœ ì§€ì¤‘...</div>
        </div>

        <div id="result-message"></div>

        <button id="start-btn" onclick="start()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
    </div>

    <script type="text/javascript">
        // ==========================================
        // â˜… ì—…ë°ì´íŠ¸í•´ì£¼ì‹  ì£¼ì†Œë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤! â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycby1vY_yLSrRaMCaSZvOjDp7cGJgutJF_xs38mkXz2-29gOgb7HUl3_GUMg49Jci7xxW/exec"; 
        // ==========================================

        const URL = "https://teachablemachine.withgoogle.com/models/gyHF-v61C/";

        let model, webcam, maxPredictions;
        let isGameRunning = false;
        let score = 0;
        let currentQuestionIndex = 0;
        let isAnswering = false;
        
        // ì´ë¦„ ì €ì¥ ë³€ìˆ˜
        let playerName = ""; 

        let lastClass = "";       
        let holdStartTime = 0;    
        const HOLD_DURATION = 5000; 

        const quizData = [
            { q: "1. ëŒ€í•œë¯¼êµ­ ìˆ˜ë„ëŠ” ì„œìš¸ì´ë‹¤.", a: "O" },
            { q: "2. ì‚¬ê³¼ëŠ” ì˜ì–´ë¡œ Bananaì´ë‹¤.", a: "X" },
            { q: "3. ê±°ë¶ì´ëŠ” íŒŒì¶©ë¥˜ì´ë‹¤.", a: "O" },
            { q: "4. ë¬¼ì€ 50ë„ì—ì„œ ë“ëŠ”ë‹¤.", a: "X" },
            { q: "5. í­ê·„ì€ í•˜ëŠ˜ì„ ë‚  ìˆ˜ ìˆë‹¤.", a: "X" }
        ];

        // ----------------------------------------------------
        // ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ì´ë¦„ í¬í•¨)
        // ----------------------------------------------------
        function sendToSpreadsheet(userAnswer, currentScore, pName) {
            const data = {
                result: userAnswer, 
                score: currentScore,
                name: pName 
            };

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(() => console.log("ë°ì´í„° ì „ì†¡ ì™„ë£Œ"))
            .catch(err => console.error("ì „ì†¡ ì‹¤íŒ¨:", err));
        }

        async function start() {
            const startBtn = document.getElementById("start-btn");
            const nameInput = document.getElementById("name-input");

            // ì´ë¦„ ì…ë ¥ í™•ì¸
            if (nameInput.value.trim() === "") {
                alert("ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¦„ì„ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nameInput.focus();
                return;
            }
            playerName = nameInput.value.trim(); 

            if (typeof tmImage === 'undefined') {
                alert("ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            try {
                startBtn.innerHTML = "ë¡œë”©ì¤‘...";
                startBtn.disabled = true;
                nameInput.disabled = true; 

                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true; 
                webcam = new tmImage.Webcam(400, 400, flip); 
                await webcam.setup(); 
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").innerHTML = "";
                document.getElementById("webcam-container").appendChild(webcam.canvas);

                startGameLogic();

            } catch (error) {
                console.error(error);
                alert("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜");
                startBtn.innerHTML = "ë‹¤ì‹œ ì‹œë„í•˜ê¸°";
                startBtn.disabled = false;
                nameInput.disabled = false;
            }
        }

        function startGameLogic() {
            isGameRunning = true;
            score = 0;
            currentQuestionIndex = 0;
            updateScore();
            document.getElementById("start-btn").style.display = "none"; 
            document.getElementById("name-input").style.display = "none";
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                endGame();
                return;
            }
            const qBox = document.getElementById("question-box");
            qBox.innerText = quizData[currentQuestionIndex].q;
            document.getElementById("result-message").innerText = "";
            
            resetTimer();
            isAnswering = false;
        }

        async function loop() {
            webcam.update(); 
            if (isGameRunning && !isAnswering) {
                await predict();
            }
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let highestProbability = 0;
            let bestClass = "";

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProbability) {
                    highestProbability = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }

            if (highestProbability > 0.90) {
                if (bestClass === lastClass) {
                    const timePassed = Date.now() - holdStartTime;
                    updateProgressBar(timePassed, bestClass);
                    if (timePassed >= HOLD_DURATION) {
                        checkAnswer(bestClass);
                        resetTimer(); 
                    }
                } else {
                    lastClass = bestClass;
                    holdStartTime = Date.now();
                    resetTimerUI(); 
                }
            } else {
                lastClass = "";
                resetTimer();
            }
        }

        function updateProgressBar(timePassed, className) {
            const container = document.getElementById("progress-container");
            const bar = document.getElementById("progress-bar");
            const text = document.getElementById("progress-text");
            container.style.display = "block"; 
            const percent = Math.min((timePassed / HOLD_DURATION) * 100, 100);
            bar.style.width = percent + "%";
            const seconds = (timePassed / 1000).toFixed(1);
            text.innerText = `${className} ìœ ì§€ ì¤‘... (${seconds}ì´ˆ)`;
        }

        function resetTimer() {
            holdStartTime = Date.now(); 
            resetTimerUI();
        }

        function resetTimerUI() {
            const container = document.getElementById("progress-container");
            const bar = document.getElementById("progress-bar");
            container.style.display = "none"; 
            bar.style.width = "0%";
        }

        function checkAnswer(userAnswer) {
            isAnswering = true;
            resetTimerUI(); 

            const correctAns = quizData[currentQuestionIndex].a;
            const resultMsg = document.getElementById("result-message");

            if (userAnswer === correctAns) {
                score++;
                updateScore();
                resultMsg.innerText = "ì •ë‹µ! â­•";
                resultMsg.className = "correct";
            } else {
                resultMsg.innerText = "ë•¡! âŒ";
                resultMsg.className = "wrong";
            }

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2000);
        }

        function updateScore() {
            document.getElementById("score-val").innerText = score;
        }

        function endGame() {
            isGameRunning = false;
            document.getElementById("question-box").innerText = 
                `${playerName}ë‹˜ì˜ ìµœì¢… ì ìˆ˜: ${score}ì `;
            
            let msg = "";
            if (score === 5) msg = "ì™„ë²½í•´ìš”! ğŸ’¯";
            else if (score >= 3) msg = "ì°¸ ì˜í–ˆì–´ìš”! ğŸ†";
            else msg = "ì¡°ê¸ˆ ë” ë¶„ë°œí•˜ì„¸ìš”! ğŸ’ª";
            
            document.getElementById("result-message").innerText = msg;
            
            // ê²Œì„ ì™„ë£Œ ì‹œ ì´ë¦„ê³¼ ì ìˆ˜ ì „ì†¡
            sendToSpreadsheet("ì™„ë£Œ", score, playerName); 
            
            const btn = document.getElementById("start-btn");
            const nameInput = document.getElementById("name-input");
            
            btn.style.display = "inline-block";
            btn.innerHTML = "ë‹¤ì‹œ í•˜ê¸°";
            btn.disabled = false;
            
            nameInput.style.display = "inline-block";
            nameInput.disabled = false;
            nameInput.value = "";
        }
    </script>
</body>
</html>