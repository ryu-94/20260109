<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ëª¸ìœ¼ë¡œ ë§í•´ìš” í€´ì¦ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        #score-board {
            position: absolute;
            top: 20px;
            right: 30px;
            background-color: #ff6b6b;
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
        }
        h1 { margin-bottom: 10px; color: #4a90e2; }
        #question-box {
            font-size: 28px;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #eee;
            border-radius: 15px;
            padding: 20px;
        }
        #webcam-container {
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            border: 5px solid #ddd;
            width: 400px; 
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #333;
            position: relative;
        }
        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        /* ë¡œë”© ë°” ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 10px;
            height: 30px;
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: relative;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #2ecc71; /* ì´ˆë¡ìƒ‰ */
            transition: width 0.1s linear;
        }
        #progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 5px;
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }

        #start-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Jua', sans-serif;
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); background-color: #357abd; }
        #start-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #result-message {
            font-size: 40px;
            font-weight: bold;
            height: 50px;
            margin-top: 10px;
        }
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }
    </style>
</head>
<body>

    <div id="score-board">ì ìˆ˜: <span id="score-val">0</span>ì </div>

    <div class="container">
        <h1>ğŸ¤– AI O/X í€´ì¦ˆ ê²Œì„</h1>
        <div id="question-box">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
        
        <div id="webcam-container">
            <span style="color:white; font-size: 20px;">ì¹´ë©”ë¼ ë¡œë”© ëŒ€ê¸°ì¤‘...</span>
        </div>

        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="progress-text">ìì„¸ ìœ ì§€ì¤‘...</div>
        </div>

        <div id="result-message"></div>

        <button id="start-btn" onclick="start()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
    </div>

    <script type="text/javascript">
        // ì„ ìƒë‹˜ì˜ ëª¨ë¸ URL
        const URL = "https://teachablemachine.withgoogle.com/models/gyHF-v61C/";

        let model, webcam, maxPredictions;
        let isGameRunning = false;
        let score = 0;
        let currentQuestionIndex = 0;
        let isAnswering = false;

        // â±ï¸ íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
        let lastClass = "";       // ì§ì „ì— ì¸ì‹ëœ ìì„¸
        let holdStartTime = 0;    // ìì„¸ë¥¼ ì¡ê¸° ì‹œì‘í•œ ì‹œê°„
        const HOLD_DURATION = 5000; // 5ì´ˆ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„) - ìˆ˜ì • ê°€ëŠ¥

        const quizData = [
            { q: "1. ëŒ€í•œë¯¼êµ­ ìˆ˜ë„ëŠ” ì„œìš¸ì´ë‹¤.", a: "O" },
            { q: "2. ì‚¬ê³¼ëŠ” ì˜ì–´ë¡œ Bananaì´ë‹¤.", a: "X" },
            { q: "3. ê±°ë¶ì´ëŠ” íŒŒì¶©ë¥˜ì´ë‹¤.", a: "O" },
            { q: "4. ë¬¼ì€ 50ë„ì—ì„œ ë“ëŠ”ë‹¤.", a: "X" },
            { q: "5. í­ê·„ì€ í•˜ëŠ˜ì„ ë‚  ìˆ˜ ìˆë‹¤.", a: "X" }
        ];

        async function start() {
            const startBtn = document.getElementById("start-btn");
            if (typeof tmImage === 'undefined') {
                alert("ì¸ê³µì§€ëŠ¥ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }
            try {
                startBtn.innerHTML = "ë¡œë”©ì¤‘...";
                startBtn.disabled = true;

                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true; 
                webcam = new tmImage.Webcam(400, 400, flip); 
                await webcam.setup(); 
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").innerHTML = "";
                document.getElementById("webcam-container").appendChild(webcam.canvas);

                startGameLogic();

            } catch (error) {
                console.error(error);
                alert("ì˜¤ë¥˜: ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                startBtn.innerHTML = "ë‹¤ì‹œ ì‹œë„í•˜ê¸°";
                startBtn.disabled = false;
            }
        }

        function startGameLogic() {
            isGameRunning = true;
            score = 0;
            currentQuestionIndex = 0;
            updateScore();
            document.getElementById("start-btn").style.display = "none"; 
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                endGame();
                return;
            }
            const qBox = document.getElementById("question-box");
            qBox.innerText = quizData[currentQuestionIndex].q;
            document.getElementById("result-message").innerText = "";
            
            // ë¬¸ì œ ë°”ë€” ë•Œ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
            resetTimer();
            isAnswering = false;
        }

        async function loop() {
            webcam.update(); 
            if (isGameRunning && !isAnswering) {
                await predict();
            }
            window.requestAnimationFrame(loop);
        }

        // ì˜ˆì¸¡ ë° 5ì´ˆ ìœ ì§€ ë¡œì§
        async function predict() {
            const prediction = await model.predict(webcam.canvas);

            let highestProbability = 0;
            let bestClass = "";

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProbability) {
                    highestProbability = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }

            // ì •í™•ë„ê°€ 90% ì´ìƒì¼ ë•Œë§Œ ì¹´ìš´íŠ¸ ì‹œì‘
            if (highestProbability > 0.90) {
                
                // 1. ì´ì „ í”„ë ˆì„ê³¼ ê°™ì€ ìì„¸ë¥¼ ìœ ì§€ ì¤‘ì´ë¼ë©´
                if (bestClass === lastClass) {
                    const timePassed = Date.now() - holdStartTime;
                    
                    // í™”ë©´ì— ê²Œì´ì§€ ì—…ë°ì´íŠ¸
                    updateProgressBar(timePassed, bestClass);

                    // 2. 5ì´ˆ(HOLD_DURATION)ê°€ ì§€ë‚¬ë‹¤ë©´ ì •ë‹µ ì œì¶œ
                    if (timePassed >= HOLD_DURATION) {
                        checkAnswer(bestClass);
                        resetTimer(); // ì œì¶œ í›„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                    }

                } else {
                    // 3. ìì„¸ê°€ ë°”ë€Œì—ˆë‹¤ë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹ ë° ì‹œì‘
                    lastClass = bestClass;
                    holdStartTime = Date.now();
                    resetTimerUI(); // UI ì´ˆê¸°í™”
                }
            } else {
                // ì •í™•ë„ê°€ ë‚®ìœ¼ë©´(ìì„¸ í’€ë¦¼) íƒ€ì´ë¨¸ ë¦¬ì…‹
                lastClass = "";
                resetTimer();
            }
        }

        // ê²Œì´ì§€ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressBar(timePassed, className) {
            const container = document.getElementById("progress-container");
            const bar = document.getElementById("progress-bar");
            const text = document.getElementById("progress-text");

            container.style.display = "block"; // ê²Œì´ì§€ ë³´ì´ê¸°
            
            // í¼ì„¼íŠ¸ ê³„ì‚° (ìµœëŒ€ 100%)
            const percent = Math.min((timePassed / HOLD_DURATION) * 100, 100);
            bar.style.width = percent + "%";
            
            // ì´ˆ ë‹¨ìœ„ í‘œì‹œ
            const seconds = (timePassed / 1000).toFixed(1);
            text.innerText = `${className} ìœ ì§€ ì¤‘... (${seconds}ì´ˆ)`;
        }

        // íƒ€ì´ë¨¸ ë° UI ì´ˆê¸°í™” í•¨ìˆ˜
        function resetTimer() {
            holdStartTime = Date.now(); // ì‹œê°„ë§Œ í˜„ì¬ë¡œ ë¦¬ì…‹ (ë‹¤ìŒ ìì„¸ ì¤€ë¹„)
            resetTimerUI();
        }

        function resetTimerUI() {
            const container = document.getElementById("progress-container");
            const bar = document.getElementById("progress-bar");
            
            container.style.display = "none"; // ê²Œì´ì§€ ìˆ¨ê¸°ê¸°
            bar.style.width = "0%";
        }

        function checkAnswer(userAnswer) {
            isAnswering = true;
            resetTimerUI(); // ì •ë‹µ ì²˜ë¦¬ ë˜ë©´ ê²Œì´ì§€ ì¦‰ì‹œ ìˆ¨ê¹€

            const correctAns = quizData[currentQuestionIndex].a;
            const resultMsg = document.getElementById("result-message");

            if (userAnswer === correctAns) {
                score++;
                updateScore();
                resultMsg.innerText = "ì •ë‹µ! â­•";
                resultMsg.className = "correct";
            } else {
                resultMsg.innerText = "ë•¡! âŒ";
                resultMsg.className = "wrong";
            }

            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2000);
        }

        function updateScore() {
            document.getElementById("score-val").innerText = score;
        }

        function endGame() {
            isGameRunning = false;
            document.getElementById("question-box").innerText = "ê²Œì„ ì¢…ë£Œ! ì´ì : " + score + "ì ";
            
            let msg = "";
            if (score === 5) msg = "ì™„ë²½í•´ìš”! ğŸ’¯";
            else if (score >= 3) msg = "ì°¸ ì˜í–ˆì–´ìš”! ğŸ†";
            else msg = "ì¡°ê¸ˆ ë” ë¶„ë°œí•˜ì„¸ìš”! ğŸ’ª";
            
            document.getElementById("result-message").innerText = msg;
            
            const btn = document.getElementById("start-btn");
            btn.style.display = "inline-block";
            btn.innerHTML = "ë‹¤ì‹œ í•˜ê¸°";
            btn.disabled = false;
        }
    </script>
</body>
</html>